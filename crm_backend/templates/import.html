<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import Leads - CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fas fa-graduation-cap text-blue-600 text-2xl"></i>
                <h1 class="text-2xl font-bold text-gray-800">Education CRM</h1>
            </div>
            <div class="flex items-center gap-4">
                <a href="/" class="text-gray-600 hover:text-blue-600">Dashboard</a>
                <a href="/leads/" class="text-gray-600 hover:text-blue-600">Leads</a>
                <a href="/import/" class="text-blue-600 font-semibold">Import</a>
                <a href="/reminders/" class="text-gray-600 hover:text-blue-600">Reminders</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-8">Import Leads</h1>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Excel Upload -->
            <div class="bg-white rounded-lg shadow p-8">
                <div class="flex items-center gap-3 mb-4">
                    <i class="fas fa-file-excel text-green-600 text-3xl"></i>
                    <h2 class="text-2xl font-bold text-gray-800">Import from Excel</h2>
                </div>

                <p class="text-gray-600 mb-6">Upload an Excel file with columns: Name, Phone</p>

                <div id="excelDropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-green-600 hover:bg-green-50 transition mb-4">
                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600 font-semibold mb-2">Drop Excel file here or click to select</p>
                    <p class="text-sm text-gray-500">Maximum file size: 10MB</p>
                    <input type="file" id="excelFile" accept=".xlsx" class="hidden" onchange="handleExcelUpload(event)">
                </div>

                <button onclick="document.getElementById('excelFile').click()" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-semibold flex items-center justify-center gap-2">
                    <i class="fas fa-plus"></i> Select Excel File
                </button>

                <div id="excelProgress" class="hidden mt-4">
                    <div class="bg-gray-200 rounded-full h-2 mb-2">
                        <div id="excelProgressBar" class="bg-green-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                    <p id="excelStatus" class="text-sm text-gray-600">Uploading...</p>
                </div>

                <div id="excelResult" class="hidden mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                    <p id="excelResultText" class="text-green-800"></p>
                </div>
            </div>

            <!-- CSV Upload -->
            <div class="bg-white rounded-lg shadow p-8">
                <div class="flex items-center gap-3 mb-4">
                    <i class="fas fa-file-csv text-blue-600 text-3xl"></i>
                    <h2 class="text-2xl font-bold text-gray-800">Import from CSV</h2>
                </div>

                <p class="text-gray-600 mb-6">Upload a CSV file with columns: Name, Phone</p>

                <div id="csvDropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-blue-600 hover:bg-blue-50 transition mb-4">
                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600 font-semibold mb-2">Drop CSV file here or click to select</p>
                    <p class="text-sm text-gray-500">Maximum file size: 10MB</p>
                    <input type="file" id="csvFile" accept=".csv" class="hidden" onchange="handleCSVUpload(event)">
                </div>

                <button onclick="document.getElementById('csvFile').click()" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold flex items-center justify-center gap-2">
                    <i class="fas fa-plus"></i> Select CSV File
                </button>

                <div id="csvProgress" class="hidden mt-4">
                    <div class="bg-gray-200 rounded-full h-2 mb-2">
                        <div id="csvProgressBar" class="bg-blue-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                    <p id="csvStatus" class="text-sm text-gray-600">Uploading...</p>
                </div>

                <div id="csvResult" class="hidden mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <p id="csvResultText" class="text-blue-800"></p>
                </div>
            </div>
        </div>

        <!-- Import History -->
        <div class="bg-white rounded-lg shadow p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Import History</h2>

            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-6 py-4 text-left font-semibold text-gray-800">Type</th>
                            <th class="px-6 py-4 text-left font-semibold text-gray-800">File Name</th>
                            <th class="px-6 py-4 text-left font-semibold text-gray-800">Status</th>
                            <th class="px-6 py-4 text-left font-semibold text-gray-800">Imported</th>
                            <th class="px-6 py-4 text-left font-semibold text-gray-800">Duplicates</th>
                            <th class="px-6 py-4 text-left font-semibold text-gray-800">Date</th>
                        </tr>
                    </thead>
                    <tbody id="importHistoryTable" class="divide-y">
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Drag and Drop Handlers -->
    <script>
        const API_URL = 'http://localhost:8000/api';
        const authToken = localStorage.getItem('authToken');

        // Setup drag and drop
        ['excelDropZone', 'csvDropZone'].forEach(zoneId => {
            const zone = document.getElementById(zoneId);
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                zone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            zone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (zoneId === 'excelDropZone' && files[0].name.endsWith('.xlsx')) {
                    document.getElementById('excelFile').files = files;
                    handleExcelUpload();
                } else if (zoneId === 'csvDropZone' && files[0].name.endsWith('.csv')) {
                    document.getElementById('csvFile').files = files;
                    handleCSVUpload();
                }
            });
        });

        async function handleExcelUpload() {
            const file = document.getElementById('excelFile').files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            const progressDiv = document.getElementById('excelProgress');
            const resultDiv = document.getElementById('excelResult');
            progressDiv.classList.remove('hidden');
            resultDiv.classList.add('hidden');

            try {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', `${API_URL}/imports/upload-excel/`, true);
                xhr.setRequestHeader('Authorization', `Token ${authToken}`);

                xhr.upload.addEventListener('progress', (e) => {
                    const percent = (e.loaded / e.total) * 100;
                    document.getElementById('excelProgressBar').style.width = percent + '%';
                    document.getElementById('excelStatus').textContent = `Uploading... ${Math.round(percent)}%`;
                });

                xhr.addEventListener('load', () => {
                    if (xhr.status === 202) {
                        const response = JSON.parse(xhr.responseText);
                        resultDiv.classList.remove('hidden');
                        document.getElementById('excelResultText').textContent = response.status + ' - ' + response.file_name;
                        progressDiv.classList.add('hidden');
                        loadImportHistory();
                    }
                });

                xhr.addEventListener('error', () => {
                    document.getElementById('excelStatus').textContent = 'Upload failed';
                });

                xhr.send(formData);
            } catch (error) {
                console.error('Error uploading file:', error);
                document.getElementById('excelStatus').textContent = 'Error uploading file';
            }
        }

        async function handleCSVUpload() {
            const file = document.getElementById('csvFile').files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            const progressDiv = document.getElementById('csvProgress');
            const resultDiv = document.getElementById('csvResult');
            progressDiv.classList.remove('hidden');
            resultDiv.classList.add('hidden');

            try {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', `${API_URL}/imports/upload-csv/`, true);
                xhr.setRequestHeader('Authorization', `Token ${authToken}`);

                xhr.upload.addEventListener('progress', (e) => {
                    const percent = (e.loaded / e.total) * 100;
                    document.getElementById('csvProgressBar').style.width = percent + '%';
                    document.getElementById('csvStatus').textContent = `Uploading... ${Math.round(percent)}%`;
                });

                xhr.addEventListener('load', () => {
                    if (xhr.status === 202) {
                        const response = JSON.parse(xhr.responseText);
                        resultDiv.classList.remove('hidden');
                        document.getElementById('csvResultText').textContent = response.status + ' - ' + response.file_name;
                        progressDiv.classList.add('hidden');
                        loadImportHistory();
                    }
                });

                xhr.addEventListener('error', () => {
                    document.getElementById('csvStatus').textContent = 'Upload failed';
                });

                xhr.send(formData);
            } catch (error) {
                console.error('Error uploading file:', error);
                document.getElementById('csvStatus').textContent = 'Error uploading file';
            }
        }

        async function loadImportHistory() {
            try {
                const response = await fetch(`${API_URL}/imports/status/`, {
                    headers: { 'Authorization': `Token ${authToken}` }
                });
                const history = await response.json();

                const tbody = document.getElementById('importHistoryTable');
                tbody.innerHTML = history.map(log => `
                    <tr>
                        <td class="px-6 py-4 text-gray-800">${log.import_type}</td>
                        <td class="px-6 py-4 text-gray-800">${log.file_name || 'Google Sheets'}</td>
                        <td class="px-6 py-4">
                            <span class="px-3 py-1 ${log.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'} rounded-full text-xs font-semibold">${log.status}</span>
                        </td>
                        <td class="px-6 py-4 text-gray-800">${log.imported_count}</td>
                        <td class="px-6 py-4 text-gray-800">${log.duplicate_count}</td>
                        <td class="px-6 py-4 text-gray-800">${new Date(log.started_at).toLocaleDateString()}</td>
                    </tr>
                `).join('') || '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No imports yet</td></tr>';
            } catch (error) {
                console.error('Error loading import history:', error);
            }
        }

        loadImportHistory();
        setInterval(loadImportHistory, 30000); // Refresh every 30 seconds
    </script>
</body>
</html>
